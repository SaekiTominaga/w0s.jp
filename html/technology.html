<!DOCTYPE html>
<html lang="ja" prefix="og: http://ogp.me/ns#">
	<head>
		<title>当サイトの Web 技術</title>

		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<%- include('./_include/_head_ogp') %>

		<link rel="stylesheet" href="/assets/style/w0s.css" />
		<link rel="stylesheet" href="/assets/style/layout_full.css" title="通常表示" />
		<link rel="alternate stylesheet" href="/assets/style/layout_reader.css" title="リーダー表示" id="stylesheet-print" />

		<script src="/assets/script/trusted-types.js"></script>
		<script src="/assets/script/w0s.mjs" type="module"></script>
		<script src="/assets/script/technology.mjs" type="module"></script>
		<script src="https://www.googletagmanager.com/gtag/js?id=G-SZYWFCF4JS" defer=""></script>
		<script src="/assets/script/google-analytics.js" defer=""></script>
	</head>
	<body itemscope="" itemtype="http://schema.org/WebPage">
		<div class="l-page">
			<%- include('./_include/_header') %>

			<main id="main" class="l-main">
				<div class="l-main__header">
					<div class="p-topic-path">
						<p itemprop="breadcrumb"><a href="/">ホーム</a><span class="p-topic-path__separator">&gt;</span><a aria-current="page">現在のページ</a></p>
					</div>

					<div class="p-page-title">
						<h1 itemprop="name">当サイトの Web 技術</h1>
						<p class="p-page-title__update"><span itemprop="dateModified" class="htmlbuild-datetime">2021年4月21日</span>更新</p>
					</div>

					<ol class="p-subtoc">
						<li><a href="#notice">おことわり</a></li>
						<li><a href="#history">歴史</a></li>
						<li><a href="#synthetic">全体</a></li>
						<li><a href="#html">HTML</a></li>
						<li><a href="#style">スタイルシート（CSS）</a></li>
						<li><a href="#script">スクリプト（JavaScript）</a></li>
						<li><a href="#image">画像</a></li>
						<li><a href="#compress">圧縮（Brotli）</a></li>
						<li><a href="#csp">CSP</a></li>
					</ol>
				</div>
				<div class="l-main__main">
					<section class="p-section -hdg-a" id="notice">
						<div class="p-hdg">
							<h2 class="p-hdg__hdg">おことわり</h2>
						</div>

						<ul class="p-list">
							<li>
								<p>
									ここで記載していることはすべて
									<code class="c-code">w0s.jp</code> ドメインで公開しているコンテンツに関することである。サブドメインのコンテンツは状況が異なる部分も多い。
								</p>
							</li>
							<li>
								<p>当サイトは Web 技術の実験場としての役割も兼ねており、一時的なものも含めて細かい変更は度々実施しているが、本ドキュメントはそれらに追従できるとは限らない。実際の状況と異なる部分もあるかもしれないが、細かい点はご容赦いただきたい。</p>
							</li>
						</ul>
					</section>

					<section class="p-section -hdg-a" id="history">
						<div class="p-hdg">
							<h2 class="p-hdg__hdg">歴史</h2>
						</div>

						<dl class="p-list-description">
							<dt>2001年2月</dt>
							<dd>
								<p>
									前身のサイトを開設。
									<a href="https://web.archive.org/web/20010202073300/http://www.cool.ne.jp/" class="htmlbuild-domain">COOL ONLINE</a>
									の無料会員枠を利用（容量20MB）。「地域コミュニティ」を謳っており、登録の際にまず都市を選択、それによってサブドメインが振り分けられた（e.g.
									<code class="c-code">tokyo.cool.ne.jp</code>）。
								</p>
							</dd>
							<dt>2001年6月<!-- 1日 --></dt>
							<dd>
								<p>
									掲載写真の増大により容量面で厳しくなり、
									<a href="https://web.archive.org/web/20010421065319/http://freehp.goo.ne.jp/" class="htmlbuild-domain">goo フリーホームページ</a>
									に移転（容量50MB）。 URL は <code class="c-code">http://users.goo.ne.jp/{userID}</code> だが、 IP アドレスのドメインにリダイレクトされる（ブラウザのアドレスバーには IP アドレスの数字が表示される）というすごい仕様だった。
								</p>
							</dd>
							<dt>2002年3月<!-- 26日 --></dt>
							<dd>
								<p>
									<a href="http://www.nurs.or.jp/" class="htmlbuild-domain">ネットワーク利用技術研究会（NURS）</a>
									に移転。レンタルサーバーではなく研究・実験目的のサーバーであり、 telnet が制限なしに使えたので、 root 権限が必要なこと以外は割となんでもできた。
								</p>
							</dd>
							<dt>2012年2月<!-- 12日 --></dt>
							<dd>
								<p>
									NURS はドメインが全ユーザー共通であり（サブドメインで分ける方式ではなかった）、 Cookie の導入がセキュリティ上の理由で躊躇われることから
									<a href="https://www.inetd.co.jp/" class="htmlbuild-domain">アイネットディー（inetd）</a>
									に移転したうえで独自ドメインを取得。\270/月の格安サーバーにしては cron の制限が緩いのがありがたかった。
								</p>
							</dd>
							<dt>2017年1月</dt>
							<dd>
								<p>
									常時 TLS の波に乗り、 <a href="https://vps.sakura.ad.jp/" class="htmlbuild-domain">さくらのVPS</a> に移転。
									<a href="https://letsencrypt.org/" class="htmlbuild-domain">Let's Encrypt</a>
									を利用して TLS 対応を行う。
								</p>
							</dd>
						</dl>
					</section>

					<section class="p-section -hdg-a" id="synthetic">
						<div class="p-hdg">
							<h2 class="p-hdg__hdg">全体</h2>
						</div>

						<ul class="p-list">
							<li><p>HTML, CSS, JavaScript はエディターで手書き &amp; FTP ソフトでアップという昔ながらのやり方。</p></li>
							<li>
								<p>ファイル管理は Git を使っているが、外部サービスのシークレットキーなどが書かれたファイルも含まれているので、今のところ非公開リポジトリにしている。いずれ切り分けて、公開できるものは公開したい。</p>
							</li>
						</ul>
					</section>

					<section class="p-section -hdg-a" id="html">
						<div class="p-hdg">
							<h2 class="p-hdg__hdg">HTML</h2>
						</div>

						<figure class="p-code">
							<figcaption class="p-code__caption">HTML ファイルの構成図</figcaption>
							<div class="p-code__box">
								<pre class="p-code__code">
├─ html
│  └─ *.html
└─ w0s.jp /* DocumentRoot */
    ├─ *.html
    ├─ *.min.html
    └─ *.min.html.br
</pre
								>
							</div>
						</figure>

						<ul class="p-list">
							<li>
								<p><code class="c-code">html</code> ディレクトリ（非公開領域）内の HTML ファイルを自作の Node.js プログラムでビルドし、 DocumentRoot 以下に配置。ビルドの際はページヘッダー、サイドバーなど共通部分を結合した後、以下の3ファイルを出力している。</p>
								<ul>
									<li><a href="https://prettier.io/" class="htmlbuild-domain">Prettier</a> でフォーマットしたファイル（e.g. <code class="c-code">index.html</code>）</li>
									<li><a href="https://github.com/kangax/html-minifier" hreflang="en" class="htmlbuild-domain">html-minifier</a> で最小化したファイル（e.g. <code class="c-code">index.min.html</code>）</li>
									<li>最小化ファイルを Brotli 圧縮したファイル（e.g. <code class="c-code">index.min.html.br</code>）</li>
								</ul>
							</li>
							<li>
								<p>
									ウェブページの URL に拡張子が含まれるのは好ましくないと考えているので、 Apcahe の設定で拡張子なしの URL でアクセスできるようにしており、その場合は
									<code class="c-code">*.min.html</code> のファイルが読まれる。
								</p>
								<ul>
									<li>
										<p>Brotli に対応したブラウザ（Accept-Encoding リクエストヘッダーに <code class="c-code">br</code> が含まれる場合）は、 <code class="c-code">*.min.html.br</code> が読まれる。<a href="#compress">圧縮の詳細</a>については後述する。</p>
									</li>
									<li>
										<p>
											上記のとおり、最小化されていないファイルも公開領域にアップロードしているので、手動で URL 末尾に
											<code class="c-code">.html</code> を付けると、人間が目で見やすいソースコードを見ることができる（隠し機能扱い）。
										</p>
									</li>
									<li>
										<p>ただし、ブログページなどサーバーサイドで動的にレスポンスを出力しているコンテンツは HTML ファイルが存在しないため、 URL に拡張子を付けても意味がなく、「404 Not Found」になる。</p>
									</li>
								</ul>
							</li>
							<li>
								<p>以前は <code class="c-code">application/xhtml+xml</code> で配信していたが、 Twitter の埋め込みウィジェット（widgets.js）が動かないなどの外部要因により、やむなく <code class="c-code">text/html</code> に変更している。それに伴い、最小化設定も属性値の引用符を削除するなど XML 構文としては well-formed でないものにしている。</p>
							</li>
							<li>
								<p>
									編集用ファイルは引き続き XML 構文で作成している（e.g.
									<code class="c-code">&lt;input readonly=""/&gt;</code>）。周辺状況が改善されれば配信ファイルも再び <code class="c-code">application/xhtml+xml</code> に戻すかもしれない（と思い続けて幾年月）。
								</p>
							</li>
						</ul>

						<section class="p-section -hdg-c" id="html-build">
							<div class="p-hdg">
								<h3 class="p-hdg__hdg">ビルド</h3>
							</div>

							<ul class="p-list">
								<li>
									<p>ビルドの際、整形や最小化以外にも下記3つの処理を行っている。</p>
									<ul>
										<li>(1) ページヘッダー、サイドバーなど共通部分を結合</li>
										<li>(2) リンクアンカー直後にドメイン情報を付与</li>
										<li>(3) <code class="c-code">&lt;time&gt;</code> 要素の datetime 属性を生成</li>
									</ul>
								</li>
								<li>
									<p>当サイトでは外部サイトへのハイパーリンクのアンカーに対してドメイン名（FQDN）を明記している。 URL から手動でドメイン部分を抜き出すのはミスが起こりうるため、クラス名 <code class="c-code">htmlbuild-domain</code> を記した <code class="c-code">&lt;a&gt;</code> 要素の href 属性値を解析し、アンカー直後に自動挿入する。</p>
									<ul>
										<li>変換前: <code class="c-code">&lt;a href="https://example.com/foo" class="htmlbuild-domain c-anchor"&gt;Link&lt;/a&gt;</code></li>
										<li>
											変換後:
											<code class="c-code">&lt;a href="https://example.com/foo" class="c-anchor"&gt;Link&lt;/a&gt;&lt;b class="c-domain"&gt;(example.com)&lt;/b&gt;&lt;/p&gt;</code>
										</li>
									</ul>
								</li>
								<li>
									<p><code class="c-code">&lt;time&gt;</code> 要素の datetime 属性を手動でマークアップするのはミスが起こりうるため、クラス名 <code class="c-code">htmlbuild-datetime</code> を記した <code class="c-code">&lt;span&gt;</code> 要素の中身（textContent）を解析し、 <code class="c-code">&lt;time&gt;</code> 要素に自動変換する。</p>
									<ul>
										<li>変換前: <code class="c-code">&lt;span class="htmlbuild-datetime c-date"&gt;2000年1月1日&lt;/span&gt;</code></li>
										<li>変換後: <code class="c-code">&lt;time datetime="2000-01-01" class="c-date"&gt;2000年1月1日&lt;/time&gt;</code></li>
									</ul>
									<p>
										なお、 datetime 属性が不要なケースや、
										<code class="c-code">&lt;time datetime="2019-05-01"&gt;令和最初の日&lt;/time&gt;</code> のように機械的な解析が困難なケースは <code class="c-code">&lt;time&gt;</code> 要素を直接マークアップする。
									</p>
								</li>
							</ul>
						</section>

						<section class="p-section -hdg-c" id="html-errorpage">
							<div class="p-hdg">
								<h3 class="p-hdg__hdg">エラーページ</h3>
							</div>

							<ul class="p-list">
								<li>
									<p>Apache がデフォルトで用意しているエラーページは味気ないので、下記に示すレスポンスコードの場合は独自のエラーページを用意している。（※下記リンク先は実際の応答までは再現していないので、いずれも 200 になる。）</p>
									<ul>
										<li><a href="/errorpage/401" referrerpolicy="no-referrer">401 Unauthorized</a></li>
										<li><a href="/errorpage/403" referrerpolicy="no-referrer">403 Forbidden</a></li>
										<li><a href="/errorpage/404" referrerpolicy="no-referrer">404 Not Found</a></li>
										<li><a href="/errorpage/405" referrerpolicy="no-referrer">405 Method Not Allowed</a></li>
										<li><a href="/errorpage/410" referrerpolicy="no-referrer">410 Gone</a></li>
										<li><a href="/errorpage/500" referrerpolicy="no-referrer">500 Internal Server Error</a></li>
										<li><a href="/errorpage/503" referrerpolicy="no-referrer">503 Service Unavailable</a></li>
									</ul>
								</li>
								<li>
									<p>403, 404, 410 のエラーページには JavaScript で以下の機能を組み込んでいる。</p>
									<ul>
										<li>
											<p>
												同一ドメインのリファラーがあった場合（= サイト内から無効なリンクが貼られている）は管理者へ通知する。なお、上記リンクアンカーには
												<code class="c-code">referrerpolicy="no-referrer"</code> を設定しており、例外的に通知は行われない。
											</p>
										</li>
										<li>
											<p>直近の有効な祖先ディレクトリへのリンクを提示する。（e.g. <code class="c-code">/foo/bar/baz</code> へのリクエストに対し、 <code class="c-code">/foo/bar/baz</code> のレスポンスコードが 404 で <code class="c-code">/foo/bar/</code> が 403、 <code class="c-code">/foo/</code> が 200 の場合、 <code class="c-code">/foo/</code> へのリンクアンカーを提示）</p>
										</li>
										<li>
											<p><a href="https://wicg.github.io/portals/" hreflang="en" class="htmlbuild-domain">&lt;portal&gt; 要素</a>に対応した環境では祖先ディレクトリへの誘導をテキストリンクだけでなく、 <code class="c-code">&lt;portal&gt;</code> を利用した埋め込みも行うことで、遷移前にそのページのイメージが掴めるようにしている。（@see ブログ記事「<a href="https://blog.w0s.jp/588">404ページに &lt;portal&gt; 要素を導入</a>」）</p>
										</li>
									</ul>
								</li>
							</ul>
						</section>
					</section>

					<section class="p-section -hdg-a" id="style">
						<div class="p-hdg">
							<h2 class="p-hdg__hdg">スタイルシート（CSS）</h2>
						</div>

						<figure class="p-code">
							<figcaption class="p-code__caption">CSS ファイルの構成図</figcaption>
							<div class="p-code__box">
								<pre class="p-code__code">
└─ w0s.jp /* DocumentRoot */
    └─ assets
        ├─ _css
        │  └─ *.css
        └─ style
            ├─ *.css
            ├─ *.css.br
            └─ *.css.map
</pre
								>
							</div>
						</figure>

						<ul class="p-list">
							<li>
								<p><code class="c-code">w0s.jp/assets/_css</code> ディレクトリ内の CSS ファイルを <a href="https://postcss.org/" class="htmlbuild-domain">PostCSS</a>でビルドし、 <code class="c-code">w0s.jp/assets/style</code> に配置。ビルドの際、ソースマップ、 Brotli 圧縮ファイルも同時に出力している。</p>
							</li>
							<li>
								<p>PostCSS の導入はブラウザが対応していない機能の先行使用、あるいはファイルをまとめることによるブラウザからの読み込みパフォーマンスの向上が目的であり、標準化の見込みのないプラグインは極力使わず、将来的には変換前のコードをそのままブラウザに読み込ませても問題ないようにすることが目標である。</p>
								<p>現在使っているプラグインは以下の5つ。このうち postcss-apply は仕様策定が破棄されたのでいずれ廃止したい。</p>
								<table class="p-table-data" style="--component-interval-ratio: 0.5">
									<thead>
										<tr>
											<th scope="col">プラグイン</th>
											<th scope="col">CSS 仕様</th>
											<th scope="col">W3C プロセス</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td><a href="https://github.com/pascalduez/postcss-apply" hreflang="en">postcss-apply</a></td>
											<td><a href="https://tabatkins.github.io/specs/css-apply-rule/" hreflang="en">CSS @apply Rule</a></td>
											<td>Unofficial Proposal Draft</td>
										</tr>
										<tr>
											<td><a href="https://github.com/postcss/postcss-custom-media" hreflang="en">postcss-custom-media</a></td>
											<td><a href="https://drafts.csswg.org/mediaqueries-5/#custom-mq" hreflang="en">Custom Media Queries (Media Queries Level 5)</a></td>
											<td>Editor’s Draft</td>
										</tr>
										<tr>
											<td><a href="https://github.com/postcss/postcss-import" hreflang="en">postcss-import</a></td>
											<td></td>
											<td></td>
										</tr>
										<tr>
											<td><a href="https://github.com/jonathantneal/postcss-nesting" hreflang="en">postcss-nesting</a></td>
											<td><a href="https://drafts.csswg.org/css-nesting-1/" hreflang="en">CSS Nesting Module</a></td>
											<td>Editor’s Draft</td>
										</tr>
										<tr>
											<td><a href="https://cssnano.co/" hreflang="en">CSSNANO</a></td>
											<td></td>
											<td></td>
										</tr>
									</tbody>
								</table>
							</li>
							<li>
								<p>ブラウザから読まれる CSS ファイルは上記のとおり <a href="https://cssnano.co/" hreflang="en" class="htmlbuild-domain">CSSNANO</a>を利用した minify 処理を行っているが、 <code class="c-code">SourceMap</code> ヘッダーでソースマップを出力しているため、ブラウザの開発者ツールを使えば元ファイルにアクセスできる。</p>
							</li>
						</ul>

						<section class="p-section -hdg-c" id="style-print">
							<div class="p-hdg">
								<h3 class="p-hdg__hdg">印刷用スタイル</h3>
							</div>

							<ul class="p-list">
								<li>
									<p>
										用紙やインクを節約するため、背景色を <code class="c-code">#ffffff</code>
										にしたり、ヘッダーやフッターを非表示にしたりといった簡易な印刷用スタイルを作成している。
									</p>
								</li>
								<li>
									<p>以前は <code class="c-code">@print</code> を使っていたが、半強制的に画面表示時と異なる状態で印刷されることが混乱をもたらす可能性を考え、<a href="https://html.spec.whatwg.org/multipage/links.html#the-link-is-an-alternative-stylesheet" hreflang="en" class="htmlbuild-domain">代替スタイルシート</a>機構を使うようにした。 Firefox ではメニューバーの「表示」-「スタイルシート」から切り替え可能である。 Chrome や Vivaldi でも拡張機能が公開されている。</p>
								</li>
								<li>
									<p>切替機構を持たないブラウザに対しては JavaScript を使って強制適用させるようにしている。（@see ブログ記事「<a href="https://blog.w0s.jp/612">印刷用スタイルを @media print から代替スタイルシートへ変更</a>」）</p>
								</li>
							</ul>
						</section>
					</section>

					<section class="p-section -hdg-a" id="script">
						<div class="p-hdg">
							<h2 class="p-hdg__hdg">スクリプト（JavaScript）</h2>
						</div>

						<figure class="p-code">
							<figcaption class="p-code__caption">JavaScript ファイルの構成図</figcaption>
							<div class="p-code__box">
								<pre class="p-code__code">
└─ w0s.jp /* DocumentRoot */
    └─ assets
        ├─ _js
        │  ├─ *.js
        │  ├─ *.mjs.js
        ├─ _ts
        │  ├─ *.ts
        │  └─ *.mjs.ts
        └─ script
            ├─ *.js
            ├─ *.js.br
            ├─ *.js.map
            ├─ *.mjs
            ├─ *.mjs.br
            └─ *.mjs.map
</pre
								>
							</div>
						</figure>

						<ul class="p-list">
							<li>
								<p>ほとんどのスクリプトは module script であり、拡張子を <code class="c-code">*.mjs.ts</code> で作っている。これは最終的に <code class="c-code">*.mjs</code> に変換され、 <code class="c-code">*.js</code> ファイルと区別することができる。</p>
							</li>
							<li>
								<p><code class="c-code">w0s.jp/assets/_ts</code> ディレクトリ内の TypeScript ファイルを <code class="c-code">tsc</code> コマンドで変換して <code class="c-code">w0s.jp/assets/_js</code> ディレクトリ内に生成。</p>
								<ul>
									<li><code class="c-code">*.ts</code> → <code class="c-code">*.js</code></li>
									<li><code class="c-code">*.mjs.ts</code> → <code class="c-code">*.mjs.js</code></li>
								</ul>
								<p>その生成を検知して <a href="https://terser.org/" class="htmlbuild-domain">terser</a>で最小化したファイルを <code class="c-code">w0s.jp/assets/script</code> に配置。その際、ソースマップ、 Brotli 圧縮ファイルも同時に出力している。</p>
							</li>
							<li>
								<p>Apache では拡張子と MIME types の紐付けは mime.types ファイルで定義されているが、 JavaScript 関係は .js のみで .mjs は含まれていない。どちらにせよ文字エンコーディングの指定を行う必要があるため、 .conf ファイルで以下の指定をしている。</p>
								<p><code class="c-code">AddType "application/javascript; charset=utf-8" .js .mjs</code></p>
							</li>
							<li><p>CSS と異なり、ファイルの結合は行っていない。</p></li>
							<li>
								<p>
									ブラウザから読まれる JavaScript ファイルは上記のとおり minify 処理を行っているが、
									<code class="c-code">SourceMap</code> ヘッダーでソースマップを出力しているため、ブラウザの開発者ツールを使えば元ファイルにアクセスできる。
								</p>
							</li>
						</ul>

						<section class="p-section -hdg-c" id="script-error">
							<div class="p-hdg">
								<h3 class="p-hdg__hdg">エラー検知</h3>
							</div>

							<ul class="p-list">
								<li>
									<p>制作したスクリプト機能は Firefox, Chrome 最新版での軽い確認はしているが、きちんとしたテストは行っていない。その代わり、 error イベントを検知して管理者へ通知する機能を組み込んでいる。簡略化したコード例を下記に示す。</p>
									<div class="p-code" style="--component-interval-ratio: 0">
										<div class="p-code__box">
											<div class="p-code__clipboard">
												<button type="button" is="w0s-clipboard" data-target-for="script-error-code" class="p-code__clipboard-button">
													<img src="/assets/image/copy.svg" alt="コピー" />
												</button>
											</div>
											<pre class="p-code__code"><code id="script-error-code" class="htmlbuild-highlight">window.addEventListener('error', (ev) => {
  const formData = new FormData();
  formData.append('location', location.toString());
  formData.append('message', ev.message);
  formData.append('filename', ev.filename);
  formData.append('lineno', String(ev.lineno));
  formData.append('colno', String(ev.colno));

  fetch(ENDPOINT, {
    method: 'POST',
    body: new URLSearchParams([...formData]),
  });
});
</code></pre>
										</div>
									</div>
								</li>
								<li>
									<p>これにより、事前のテストでは把握が難しい以下のようなケースも検知することができる。</p>
									<ul>
										<li>古いブラウザや検索エンジンのロボットで発生するエラー</li>
										<li>ブラウザのアドオンが原因のエラー</li>
									</ul>
								</li>
							</ul>
						</section>
					</section>

					<section class="p-section -hdg-a" id="image">
						<div class="p-hdg">
							<h2 class="p-hdg__hdg">画像</h2>
						</div>

						<div class="p-text">
							<p>ビットマップ画像とベクター画像で大きく異なるので分けて説明する。</p>
						</div>

						<section class="p-section -hdg-c" id="image-bitmap">
							<div class="p-hdg">
								<h3 class="p-hdg__hdg">ビットマップ画像（WebP, JPEG, PNG）</h3>
							</div>

							<figure class="p-code">
								<figcaption class="p-code__caption">ビットマップ画像ファイルの構成図</figcaption>
								<div class="p-code__box">
									<pre class="p-code__code">
├─ thumbimage
│  ├─ *.jpeg
│  └─ *.webp
└─ w0s.jp /* DocumentRoot */
    ├─ *.jpg
    ├─ *.png
    └─ thumbimage.php
</pre
									>
								</div>
							</figure>

							<ul class="p-list">
								<li><p>画像ファイルは Photoshop などの画像編集ソフト（GUI）を使って DocumentRoot 以下に配置。</p></li>
								<li>
									<p>
										DocumentRoot 以下に配置する JPEG ファイルの拡張子は Photoshop のデフォルト動作に合わせて <code class="c-code">.jpg</code> にしている（<code class="c-code">.jpeg</code>
										ではない）。
									</p>
								</li>
								<li>
									<p>一部のページを除き、サムネイル画像は自作の <code class="c-code">thumbimage.php</code> による自動生成を行っている。</p>
									<ul>
										<li>
											<p><code class="c-code">/thumbimage/${path};${type};w${width};mh${max-height};q${quality}</code> 形式の URL を <code class="c-code">&lt;img src&gt;</code> 等で埋め込むことで、指定したパラメーターに則りサムネイル画像を生成し、 <code class="c-code">thumbimage</code> ディレクトリ配下に保存する。その際、ファイル名に <code class="c-code">width</code>, <code class="c-code">quality</code> の情報を含めることで（e.g. <code class="c-code">foo@w=360_q=30.webp</code>）、さまざまな横幅、画質のファイルを生成することができる。</p>
										</li>
										<li><p>既にサムネイル画像が保存されている場合は、改めての生成処理は行わず、保存済みのファイルを読み取る。</p></li>
										<li>
											<p>
												ユーザーがブラウザのアドレスバーや <code class="c-code">wget</code> コマンド等で各種パラメーターを変更した URL を直接指定した際、本来不要なファイルが無駄に生成されてしまうことを避けるため、<em>画像生成時に限り</em>
												<code class="c-code">Sec-Fetch-Site</code>
												リクエストヘッダを参照することで、自サイトからの埋め込み / リンクであるかどうかを判定している。
											</p>
										</li>
										<li>
											<p>
												現在、自動生成の画像タイプは WebP と JPEG に対応している。そのため、
												<code class="c-code">&lt;picture&gt;</code> 要素を使って下記のようなマークアップをすれば、手動で用意する画像ファイルは1つだけで WebP や高画素密度ディスプレイに対応した表示を行うことができる。将来的に AVIF など新しい画像フォーマットを追加する際も、 <code class="c-code">thumbimage.php</code> を改良すれば、マークアップは機械的な置換で済むだろう。
											</p>
											<div class="p-code" style="--component-interval-ratio: 0">
												<div class="p-code__box">
													<div class="p-code__clipboard">
														<button type="button" is="w0s-clipboard" data-target-for="image-thumbimage-code" class="p-code__clipboard-button">
															<img src="/assets/image/copy.svg" alt="コピー" />
														</button>
													</div>
													<pre class="p-code__code"><code id="image-thumbimage-code" class="htmlbuild-highlight">&lt;a href="/foo.jpg" type="image/jpeg"&gt; &lt;!-- この foo.jpg は Photoshop 等の画像編集ソフトで作成 --&gt;
  &lt;picture&gt;
    &lt;source type="image/webp"
      srcset="/thumbimage/foo.jpg;webp;w360;q60, /thumbimage/foo.jpg;webp;w720;q30 2x"/&gt;
    &lt;img src="/thumbimage/foo.jpg;jpeg;w360;q60"
      srcset="/thumbimage/foo.jpg;jpeg;w720;q30 2x" alt=""/&gt;
  &lt;/picture&gt;
&lt;/a&gt;
</code></pre>
												</div>
											</div>
										</li>
										<li>
											<p>
												一般論として GET リクエストでファイルを生成するという副作用を及ぼすのは好ましいことではなく、可能なら POST や PUT を使うべきだろう。これについては
												<a href="https://tools.ietf.org/html/rfc7231#section-4.2.1" hreflang="en" class="htmlbuild-domain">RFC 7231 の 4.2.1. Safe Methods</a>
												では
												<q lang="en" cite="https://tools.ietf.org/html/rfc7231#section-4.2.1">This definition of safe methods does not prevent an implementation from including behavior that is potentially harmful, that is not entirely read-only, or that causes side effects while invoking a safe method.</q>と書かれており、副作用を起こす実装が禁止されているものではないこと、アクセスログのように GET でサーバー内にファイルを追加・更新する機能は一般的に存在すること、そもそも本機能の要件は GET でないと実現できないといった理由からこのようにしている。
											</p>
										</li>
									</ul>
								</li>
							</ul>
						</section>

						<section class="p-section -hdg-c" id="image-vector">
							<div class="p-hdg">
								<h3 class="p-hdg__hdg">ベクター画像（SVG）</h3>
							</div>

							<figure class="p-code">
								<figcaption class="p-code__caption">SVG ファイルの構成図</figcaption>
								<div class="p-code__box">
									<pre class="p-code__code">
├─ svg
│  ├─ _dataurl
│  │  ├─ *.dataurl.txt
│  │  └─ *.svg
│  └─ *.svg
└─ w0s.jp /* DocumentRoot */
    ├─ *.svg
    └─ *.svg.br
</pre
									>
								</div>
							</figure>

							<ul class="p-list">
								<li>
									<p>
										簡単なものはエディターで手打ちするが、複雑な画像は Illustrator などの画像編集ソフト（GUI）で作成し、
										<code class="c-code">svg</code> ディレクトリ以下に配置。
									</p>
								</li>
								<li>
									<p><code class="c-code">svg</code> ディレクトリ（非公開領域）内の SVG ファイルを <a href="https://github.com/svg/svgo" class="htmlbuild-domain">SVGO</a> で最適化し、 DocumentRoot 以下に配置。最適化の際、 Brotli 圧縮ファイルも同時に出力している。</p>
								</li>
								<li>
									<p>
										CSS ファイルなどに data: URLs で埋め込む用途の SVG 画像は
										<code class="c-code">svg/_dataurl</code> ディレクトリ内に配置する。ここに置いたファイルは <a href="https://github.com/svg/svgo" class="htmlbuild-domain">SVGO</a> で最適化された後に Base64 でエンコードされ、同一ディレクトリに
										<code class="c-code">*.dataurl.txt</code>
										のテキストファイルが生成される。これらのファイルはページ制作の過程で素材として必要なものに過ぎないので、 DocumentRoot 以下には配置されない。
									</p>
								</li>
							</ul>
						</section>
					</section>

					<section class="p-section -hdg-a" id="compress">
						<div class="p-hdg">
							<h2 class="p-hdg__hdg">圧縮（Brotli）</h2>
						</div>

						<ul class="p-list">
							<li>
								<p>
									以下のレスポンスは Apache の機能により、リクエスト発生時に Brotli の圧縮を行う。圧縮品質の個別の調整は行わず、
									<a href="https://httpd.apache.org/docs/2.4/en/mod/mod_brotli.html" hreflang="en" class="htmlbuild-domain">mod_brotli</a>
									のデフォルト設定に従う。
								</p>
								<ul>
									<li>text/css</li>
									<li>text/html</li>
									<li>application/atom+xml</li>
									<li>application/javascript</li>
									<li>application/json</li>
									<li>application/opensearchdescription+xml</li>
									<li>application/xhtml+xml</li>
									<li>image/svg+xml</li>
								</ul>
							</li>
							<li>
								<p>前述のとおり、 HTML, CSS, JavaScript, SVG は事前に静的な Brotli ファイル（<code class="c-code">*.br</code>）を生成する。これらは圧縮品質を最高にし、極力ファイルサイズが小さくなるようにしている。</p>
							</li>
							<li>
								<p>他に text/plain （e.g. <code class="c-code">ads.txt</code>, <code class="c-code">robots.txt</code>）や application/manifest+json （e.g. <code class="c-code">manifest.webmanifest</code>）で提供されるリソースも存在するが、いずれもファイルサイズが小さく、また用途も限定されているため、圧縮は行わない。</p>
							</li>
						</ul>
					</section>

					<section class="p-section -hdg-a" id="csp">
						<div class="p-hdg">
							<h2 class="p-hdg__hdg">CSP</h2>
						</div>

						<ul class="p-list">
							<li>
								<p>Fetch ディレクティブ（*-src）は <code class="c-code">Content-Security-Policy-Report-Only</code> で設定。</p>
								<p>ユーザースタイルシート、ユーザースクリプトによるカスタマイズを妨げないため、あくまで実態調査目的として Report-Only にしている。</p>
							</li>
							<li>
								<p>Trusted Types 関係も現状は <code class="c-code">Content-Security-Policy-Report-Only</code> で設定。</p>
							</li>
							<li>
								<p>それ以外のディレクティブは <code class="c-code">Content-Security-Policy</code> で設定。</p>
							</li>
							<li>
								<p>Reporting は <a href="https://report-uri.com/" hreflang="en" class="htmlbuild-domain">Report URI</a> を利用。</p>
							</li>
							<li>
								<p>当サイトでは主に以下の外部サービスを使っているため、これらの指定が多くを占める。</p>
								<ul>
									<li>Amazon アソシエイトリンク</li>
									<li>Google AdSense</li>
									<li>Google アナリティクス</li>
									<li>ツイート埋め込み</li>
									<li>YouTube 動画埋め込み</li>
								</ul>
							</li>
						</ul>

						<section class="p-section -hdg-c" id="csp-enforce">
							<div class="p-hdg">
								<h3 class="p-hdg__hdg">Content-Security-Policy の設定値</h3>
							</div>

							<table class="p-table-data" id="csp-enforce-table">
								<thead>
									<tr>
										<th scope="col">ディレクティブ</th>
										<th scope="col">値</th>
										<th scope="col">備考</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<th scope="row">base-uri</th>
										<td>'none'</td>
										<td></td>
									</tr>
								</tbody>
								<tbody>
									<tr>
										<th scope="row" rowspan="4">form-action</th>
										<td>'self'</td>
										<td></td>
									</tr>
									<tr>
										<td>https://blog.w0s.jp</td>
										<td></td>
									</tr>
									<tr>
										<td>https://www.google.com</td>
										<td>ページヘッダーのサイト内検索</td>
									</tr>
									<tr>
										<td>https://api.twitter.com</td>
										<td>Twitter アカウントによるログイン機能（OAuth）</td>
									</tr>
									<tr>
										<th scope="row">frame-ancestors</th>
										<td>'self'</td>
										<td>この設定により <code class="c-code">X-Frame-Options</code> を廃止</td>
									</tr>
								</tbody>
								<tbody>
									<tr>
										<th scope="row">block-all-mixed-content</th>
										<td></td>
										<td></td>
									</tr>
								</tbody>
								<tbody>
									<tr>
										<th scope="row">report-uri</th>
										<td>https://w0sjp.report-uri.com/r/d/csp/enforce</td>
										<td></td>
									</tr>
								</tbody>
							</table>

							<figure class="p-code">
								<figcaption class="p-code__caption">実際の設定値</figcaption>
								<div class="p-code__box">
									<div class="p-code__clipboard">
										<button type="button" is="w0s-clipboard" data-target-for="csp-enforce-output" class="p-code__clipboard-button">
											<img src="/assets/image/copy.svg" alt="コピー" />
										</button>
									</div>
									<pre class="p-code__code"><code id="csp-enforce-output"></code></pre>
								</div>
							</figure>
						</section>

						<section class="p-section -hdg-c" id="csp-report">
							<div class="p-hdg">
								<h3 class="p-hdg__hdg">Content-Security-Policy-Report-Only の設定値</h3>
							</div>

							<table class="p-table-data" id="csp-report-table">
								<thead>
									<tr>
										<th scope="col">ディレクティブ</th>
										<th scope="col">値</th>
										<th scope="col">備考</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<th scope="row">default-src</th>
										<td>'self'</td>
										<td></td>
									</tr>
									<tr>
										<th scope="row" rowspan="8">child-src</th>
										<td>'self'</td>
										<td></td>
									</tr>
									<tr>
										<td>https://blog.w0s.jp</td>
										<td></td>
									</tr>
									<tr>
										<td>https://www.google.com</td>
										<td>Google マップ埋め込み</td>
									</tr>
									<tr>
										<td>https://googleads.g.doubleclick.net</td>
										<td rowspan="3">Google AdSense</td>
									</tr>
									<tr>
										<td>https://pagead2.googlesyndication.com</td>
									</tr>
									<tr>
										<td>https://tpc.googlesyndication.com</td>
									</tr>
									<tr>
										<td>https://platform.twitter.com</td>
										<td>ツイート埋め込み</td>
									</tr>
									<tr>
										<td>https://www.youtube-nocookie.com</td>
										<td>YouTube 動画埋め込み</td>
									</tr>
									<tr>
										<th scope="row" rowspan="9">connect-src</th>
										<td>'self'</td>
										<td></td>
									</tr>
									<tr>
										<td>https://*.w0s.jp</td>
										<td></td>
									</tr>
									<tr>
										<td>https://adservice.google.com</td>
										<td rowspan="3">Google AdSense</td>
									</tr>
									<tr>
										<td>https://pagead2.googlesyndication.com</td>
									</tr>
									<tr>
										<td>https://csi.gstatic.com</td>
									</tr>
									<tr>
										<td>https://www.google-analytics.com</td>
										<td>Google アナリティクス</td>
									</tr>
									<tr>
										<td>https://fcmregistrations.googleapis.com</td>
										<td rowspan="2">Google Firebase</td>
									</tr>
									<tr>
										<td>https://firebaseinstallations.googleapis.com</td>
									</tr>
									<tr>
										<td>https://validator.w3.org</td>
										<td><a href="https://github.com/SaekiTominaga/HTMLValidator">検証用</a></td>
									</tr>
									<tr>
										<th scope="row" rowspan="10">img-src</th>
										<td>'self'</td>
										<td></td>
									</tr>
									<tr>
										<td>data:</td>
										<td>ブラウザアドオンやユーザースタイルシート</td>
									</tr>
									<tr>
										<td>https://media.w0s.jp</td>
										<td></td>
									</tr>
									<tr>
										<td>https://m.media-amazon.com</td>
										<td>Amazon アソシエイトリンク</td>
									</tr>
									<tr>
										<td>https://pagead2.googlesyndication.com</td>
										<td>Google AdSense</td>
									</tr>
									<tr>
										<td>https://www.google-analytics.com</td>
										<td rowspan="2">Google アナリティクス</td>
									</tr>
									<tr>
										<td>https://www.googletagmanager.com</td>
									</tr>
									<tr>
										<td>https://*.twimg.com</td>
										<td rowspan="2">ツイート埋め込み</td>
									</tr>
									<tr>
										<td>https://syndication.twitter.com</td>
									</tr>
									<tr>
										<td>https://*.ytimg.com</td>
										<td>YouTube 動画のサムネイル画像</td>
									</tr>
									<tr>
										<th scope="row" rowspan="12">script-src</th>
										<td>'self'</td>
										<td></td>
									</tr>
									<tr>
										<td>'unsafe-inline'</td>
										<td>ブラウザアドオン、ユーザースクリプト</td>
									</tr>
									<tr>
										<td>https://adservice.google.co.jp</td>
										<td rowspan="6">Google AdSense</td>
									</tr>
									<tr>
										<td>https://adservice.google.com</td>
									</tr>
									<tr>
										<td>https://partner.googleadservices.com</td>
									</tr>
									<tr>
										<td>https://pagead2.googlesyndication.com</td>
									</tr>
									<tr>
										<td>https://tpc.googlesyndication.com</td>
									</tr>
									<tr>
										<td>https://www.googletagservices.com</td>
									</tr>
									<tr>
										<td>https://www.google-analytics.com</td>
										<td rowspan="2">Google アナリティクス</td>
									</tr>
									<tr>
										<td>https://www.googletagmanager.com</td>
									</tr>
									<tr>
										<td>https://w0s-jp.web.app</td>
										<td>Google Firebase</td>
									</tr>
									<tr>
										<td>https://platform.twitter.com</td>
										<td>ツイート埋め込み</td>
									</tr>
									<tr>
										<th scope="row" rowspan="2">style-src</th>
										<td>'self'</td>
										<td></td>
									</tr>
									<tr>
										<td>'unsafe-inline'</td>
										<td>ブラウザアドオン、ユーザースタイルシート</td>
									</tr>
								</tbody>
								<tbody>
									<tr>
										<th scope="row" rowspan="4">trusted-types</th>
										<td>default</td>
										<td></td>
									</tr>
									<tr>
										<td>goog#html</td>
										<td rowspan="2">Google AdSense</td>
									</tr>
									<tr>
										<td>google#safe</td>
									</tr>
									<tr>
										<td>'allow-duplicates'</td>
										<td></td>
									</tr>
									<tr>
										<th scope="row">require-trusted-types-for</th>
										<td>'script'</td>
										<td></td>
									</tr>
								</tbody>
								<tbody>
									<tr>
										<th scope="row">report-uri</th>
										<td>https://w0sjp.report-uri.com/r/d/csp/reportOnly</td>
										<td></td>
									</tr>
								</tbody>
							</table>

							<figure class="p-code">
								<figcaption class="p-code__caption">実際の設定値</figcaption>
								<div class="p-code__box">
									<div class="p-code__clipboard">
										<button type="button" is="w0s-clipboard" data-target-for="csp-report-output" class="p-code__clipboard-button">
											<img src="/assets/image/copy.svg" alt="コピー" />
										</button>
									</div>
									<pre class="p-code__code"><code id="csp-report-output"></code></pre>
								</div>
							</figure>
						</section>
					</section>
				</div>
			</main>

			<%- include('./_include/_sidebar') %> <%- include('./_include/_footer') %>
		</div>
	</body>
</html>
