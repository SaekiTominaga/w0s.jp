---
import { actions } from 'astro:actions';
import type { z } from 'astro/zod';
import GithubSlugger from 'github-slugger';
import { env } from '@w0s/env-value-type';
import Layout from '@layouts/Admin.astro';
import FormGrid from '@components/FormGrid.astro';
import FormButtons from '@components/FormButtons.astro';
import FormGridGroup from '@components/FormGridGroup.astro';
import FormValidateMsg from '@components/FormValidateMsg.astro';
import Section from '@components/Section.astro';
import Table from '@components/Table.astro';
import SubmitButton from '@components/+phrasing/SubmitButton.astro';
import FormCtrlInput from '@components/+phrasing/FormCtrlInput.astro';
import FormCtrlSelect from '@components/+phrasing/FormCtrlSelect.astro';
import FormLabelIcon from '@components/+phrasing/FormLabelIcon.astro';
import Label from '@components/+phrasing/Label.astro';
import CrawlerNewsDao from '@db/CrawlerNews.ts';
import { response303, response400 } from '@util/httpResponse.ts';
import { getParams as getRequestParams } from '@util/request.ts';
import { init as ssrInit } from '@util/ssr.ts';
import type { StructuredData } from '../../../../@types/util.d.ts';

export const prerender = false;
const { logger } = ssrInit(Astro, { dev: import.meta.env.DEV });

const structuredData: StructuredData = {
	title: 'ã‚¦ã‚§ãƒ–å·¡å›ï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼‰',
};

let requestFormdata: FormData | undefined;
const validateMessages: string[] = [];

const insertActionResult = Astro.getActionResult(actions.crawlernews.newsinsert);
if (insertActionResult !== undefined) {
	const { data, error } = insertActionResult;

	if (data !== undefined) {
		if (data.errorMessage === undefined) {
			logger.info('ãƒ‡ãƒ¼ã‚¿ç™»éŒ²', data.url);
			return response303(Astro.request, Astro.url.pathname);
		}

		requestFormdata = await Astro.request.formData();
		validateMessages.push(data.errorMessage);
	}

	if (error !== undefined) {
		if (error.type === 'AstroActionInputError' && 'issues' in error) {
			requestFormdata = await Astro.request.formData();
			validateMessages.push(...(error.issues as z.ZodIssue[]).map((issue) => issue.message));
		} else {
			logger.warn(error.message);
			return response400();
		}
	}
}

const updateActionResult = Astro.getActionResult(actions.crawlernews.newsupdate);
if (updateActionResult !== undefined) {
	const { data, error } = updateActionResult;

	if (data !== undefined) {
		if (data.errorMessage === undefined) {
			logger.info('ãƒ‡ãƒ¼ã‚¿æ›´æ–°', data.url);
			return response303(Astro.request, Astro.url.pathname);
		}

		requestFormdata = await Astro.request.formData();
		validateMessages.push(data.errorMessage);
	}

	if (error !== undefined) {
		if (error.type === 'AstroActionInputError' && 'issues' in error) {
			requestFormdata = await Astro.request.formData();
			validateMessages.push(...(error.issues as z.ZodIssue[]).map((issue) => issue.message));
		} else {
			logger.warn(error.message);
			return response400();
		}
	}
}

const deleteActionResult = Astro.getActionResult(actions.crawlernews.newsdelete);
if (deleteActionResult !== undefined) {
	const { data, error } = deleteActionResult;

	if (data !== undefined) {
		logger.info('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤', data.id);
		return response303(Astro.request, Astro.url.pathname);
	}

	if (error !== undefined) {
		logger.warn(error.message);
		return response400();
	}
}

const slugger = new GithubSlugger();

/* åˆæœŸè¡¨ç¤º */
const dao = new CrawlerNewsDao(env('SQLITE_CRAWLER'));
const [categoryMaster, priorityMaster, newsPageListDto] = await Promise.all([
	dao.getCategoryMaster(), // ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±
	dao.getPriorityMaster(), // å„ªå…ˆåº¦æƒ…å ±
	dao.getNewsPageList(), // å·¡å›ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿
]);

const newsPageList: Map<
	string,
	{
		randomId: string;
		url: URL;
		title: string;
		priority: string;
		browser: boolean;
		selectorWrap: string;
		selectorDate: string | undefined;
		selectorContent: string | undefined;
	}[]
> = new Map();
for (const newsPage of newsPageListDto) {
	const categoryName = newsPage.category;

	const newsPageOfCategoryView = newsPageList.get(categoryName) ?? [];
	newsPageOfCategoryView.push({
		randomId: newsPage.random_id,
		url: newsPage.url,
		title: newsPage.title,
		priority: newsPage.priority,
		browser: newsPage.browser,
		selectorWrap: newsPage.selector_wrap,
		selectorDate: newsPage.selector_date,
		selectorContent: newsPage.selector_content,
	});

	newsPageList.set(categoryName, newsPageOfCategoryView);
}

const requestParams = getRequestParams(Astro.url);
const requestParamNewsId = requestParams.get('id') ?? undefined;
const reviseData = requestParamNewsId !== undefined ? await dao.getReviseData(requestParamNewsId) : undefined;
---

<Layout astroFilePath={Astro.self.moduleId} structuredData={structuredData}>
	<Section slugger={slugger}>
		<Fragment slot="heading">ãƒ‡ãƒ¼ã‚¿ç™»éŒ²</Fragment>

		<form action={reviseData === undefined && updateActionResult === undefined ? actions.crawlernews.newsinsert : actions.crawlernews.newsupdate} method="post">
			<FormValidateMsg msgs={validateMessages} />

			<FormGrid>
				<FormGridGroup>
					<Fragment slot="legend"><label for="fc-url">URL <FormLabelIcon type="required">å¿…é ˆ</FormLabelIcon></label></Fragment>

					<Fragment slot="contents">
						<FormCtrlInput><input type="url" name="url" value={requestFormdata?.get('url')?.toString() ?? reviseData?.url.toString()} required="" class="js-convert-trim" id="fc-url" /></FormCtrlInput>
					</Fragment>
				</FormGridGroup>
				<FormGridGroup>
					<Fragment slot="legend"><label for="fc-title">ã‚¿ã‚¤ãƒˆãƒ« <FormLabelIcon type="required">å¿…é ˆ</FormLabelIcon></label></Fragment>

					<Fragment slot="contents">
						<FormCtrlInput><input name="title" value={requestFormdata?.get('title')?.toString() ?? reviseData?.title} required="" class="js-convert-trim" id="fc-title" /></FormCtrlInput>
					</Fragment>
				</FormGridGroup>
				<FormGridGroup>
					<Fragment slot="legend"><label for="fc-category">ã‚«ãƒ†ã‚´ãƒªãƒ¼ <FormLabelIcon type="required">å¿…é ˆ</FormLabelIcon></label></Fragment>

					<Fragment slot="contents">
						<FormCtrlSelect>
							<select name="category" id="fc-category">
								{
									categoryMaster.map((category) => (
										<option value={category.fk} selected={Number(requestFormdata?.get('category') ?? reviseData?.category) === category.fk}>
											{category.name}
										</option>
									))
								}
							</select>
						</FormCtrlSelect>
					</Fragment>
				</FormGridGroup>
				<FormGridGroup>
					<Fragment slot="legend"><label for="fc-priority">å„ªå…ˆåº¦ <FormLabelIcon type="required">å¿…é ˆ</FormLabelIcon></label></Fragment>

					<Fragment slot="contents">
						<FormCtrlSelect>
							<select name="priority" id="fc-priority">
								{
									priorityMaster.map((priority) => (
										<option value={priority.fk} selected={Number(requestFormdata?.get('priority') ?? reviseData?.priority) === priority.fk}>
											{priority.name}
										</option>
									))
								}
							</select>
						</FormCtrlSelect>
					</Fragment>
				</FormGridGroup>
				<FormGridGroup>
					<Fragment slot="legend">ãƒ–ãƒ©ã‚¦ã‚¶</Fragment>

					<Fragment slot="contents">
						<Label label="ã‚¦ã‚§ãƒ–ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹">
							<input type="checkbox" name="browser" value="1" checked={Boolean(requestFormdata?.get('browser') ?? reviseData?.browser)} />
						</Label>
					</Fragment>
				</FormGridGroup>
				<FormGridGroup>
					<Fragment slot="legend"><label for="fc-selectorwrap">ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆåŒ…æ‹¬ï¼‰ <FormLabelIcon type="required">å¿…é ˆ</FormLabelIcon></label></Fragment>

					<Fragment slot="contents">
						<FormCtrlInput><input name="selectorwrap" value={requestFormdata?.get('selectorwrap')?.toString() ?? reviseData?.selector_wrap} required="" class="js-convert-trim" id="fc-selectorwrap" /></FormCtrlInput>
					</Fragment>
				</FormGridGroup>
				<FormGridGroup>
					<Fragment slot="legend"><label for="fc-selectordate">ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆæ—¥ä»˜ï¼‰ <FormLabelIcon type="optional">ä»»æ„</FormLabelIcon></label></Fragment>

					<Fragment slot="contents">
						<FormCtrlInput><input name="selectordate" value={requestFormdata?.get('selectordate')?.toString() ?? reviseData?.selector_date} class="js-convert-trim" id="fc-selectordate" /></FormCtrlInput>
					</Fragment>
				</FormGridGroup>
				<FormGridGroup>
					<Fragment slot="legend"><label for="fc-selectorcontent">ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆå†…å®¹ï¼‰ <FormLabelIcon type="optional">ä»»æ„</FormLabelIcon></label></Fragment>

					<Fragment slot="contents">
						<FormCtrlInput><input name="selectorcontent" value={requestFormdata?.get('selectorcontent')?.toString() ?? reviseData?.selector_content} class="js-convert-trim" id="fc-selectorcontent" /></FormCtrlInput>
					</Fragment>
				</FormGridGroup>
			</FormGrid>

			<p><input type="hidden" name="baseurl" value={requestFormdata?.get('url')?.toString() ?? reviseData?.url.toString()} /></p>

			<FormButtons>
				<p>
					{requestParamNewsId === undefined && updateActionResult === undefined && <SubmitButton>ç™»éŒ²</SubmitButton>}
					{(requestParamNewsId !== undefined || updateActionResult !== undefined) && <SubmitButton>ä¿®æ­£</SubmitButton>}
				</p>
			</FormButtons>
		</form>
	</Section>

	{
		[...newsPageList].map(([categoryName, newsPageOfCategory]) => (
			<Section slugger={slugger}>
				<Fragment slot="heading">{categoryName}</Fragment>

				<Table scroll={true}>
					<thead>
						<tr>
							<td />
							<th scope="col">å¯¾è±¡ãƒšãƒ¼ã‚¸</th>
							<th scope="col">å„ªå…ˆ</th>
							<th scope="col">ğŸŒ</th>
							<th scope="col">åŒ…æ‹¬ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼</th>
							<th scope="col">æ—¥ä»˜ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼</th>
							<th scope="col">å†…å®¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼</th>
						</tr>
					</thead>
					<tbody>
						{newsPageOfCategory.map((newsPage) => (
							<tr>
								<td>
									<form method="post">
										<p>
											<input type="hidden" name="id" value={newsPage.randomId} />
											<SubmitButton formmethod="get" buttonStyle="compact">
												ä¿®æ­£
											</SubmitButton>
											<SubmitButton formaction={actions.crawlernews.newsdelete} buttonStyle="compact" class="js-button-confirm" data-message="å‰Šé™¤ã—ã¾ã™ã‹?">
												å‰Šé™¤
											</SubmitButton>
										</p>
									</form>
								</td>
								<td>
									<a href={`/admin/crawler-news/data?newsid=${newsPage.randomId}`}>{newsPage.title}</a>
									<p style="margin-block-start: 0.5em; font-size: 80%">
										<a href={newsPage.url} referrerpolicy="no-referrer">
											{newsPage.url}
										</a>
									</p>
								</td>
								<td>{newsPage.priority}</td>
								<td>{newsPage.browser && <>âœ”</>}</td>
								<td>{newsPage.selectorWrap}</td>
								<td>{newsPage.selectorDate}</td>
								<td>{newsPage.selectorContent}</td>
							</tr>
						))}
					</tbody>
				</Table>
			</Section>
		))
	}
</Layout>
