---
import dayjs from 'dayjs';
import GithubSlugger from 'github-slugger';
import Layout from '@layouts/Tokyu.astro';
import Section from '@components/Section.astro';
import CrawlerNewsDao from '@dao/CrawlerNewsDao.js';
import HttpResponseUtil from '@util/HttpResponse.js';
import RequestUtil from '@util/Request.js';
import SsrUtil from '@util/Ssr.js';
import type { StructuredData } from '../../../types/types.js';

interface RequestQuery {
	url: string | null;
	title: string | null;
	category: number | null;
	priority: number | null;
	browser: boolean;
	selector_wrap: string | null;
	selector_date: string | null;
	selector_content: string | null;
	action_add: boolean;
	action_revise: boolean;
	action_revise_preview: boolean;
	action_delete: boolean;
}

export const prerender = false;
const { configure, logger } = SsrUtil.init(Astro);

const structuredData: StructuredData = {
	title: 'ã‚¦ã‚§ãƒ–å·¡å›ï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼‰',
	breadcrumb: [{ path: '/admin/', name: 'ãƒ›ãƒ¼ãƒ ' }],
};

const pagePath = await SsrUtil.getPageUrl(Astro.url);

const slugger = new GithubSlugger();

const requestParams = Astro.url.searchParams;
const requestBody = Astro.request.method === 'POST' ? await Astro.request.formData() : undefined;

const requestQuery: RequestQuery = {
	url: RequestUtil.string(requestParams.get('url') ?? requestBody?.get('url')),
	title: RequestUtil.string(requestBody?.get('title')),
	category: RequestUtil.number(requestBody?.get('category')),
	priority: RequestUtil.number(requestBody?.get('priority')),
	browser: RequestUtil.boolean(requestBody?.get('browser')),
	selector_wrap: RequestUtil.string(requestBody?.get('selectorwrap')),
	selector_date: RequestUtil.string(requestBody?.get('selectordate')),
	selector_content: RequestUtil.string(requestBody?.get('selectorcontent')),
	action_add: RequestUtil.boolean(requestBody?.get('actionadd')),
	action_revise: RequestUtil.boolean(requestBody?.get('actionrev')),
	action_revise_preview: RequestUtil.boolean(requestParams.get('actionrevpre')),
	action_delete: RequestUtil.boolean(requestBody?.get('actiondel')),
};

const dao = new CrawlerNewsDao(configure.sqlite.crawler);

if (requestQuery.action_add) {
	/* ç™»éŒ² */

	if (requestQuery.url !== null && requestQuery.title !== null && requestQuery.category !== null && requestQuery.priority !== null && requestQuery.selector_wrap !== null) {
		await dao.insert(requestQuery.url, requestQuery.title, requestQuery.category, requestQuery.priority, requestQuery.browser, requestQuery.selector_wrap, requestQuery.selector_date, requestQuery.selector_content);
		logger.info('ãƒ‡ãƒ¼ã‚¿ç™»éŒ²', requestQuery.url);

		const httpResponse = new HttpResponseUtil(Astro.request);
		return httpResponse.response303(); // åˆæœŸç”»é¢ã«é·ç§»
	}
} else if (requestQuery.action_revise) {
	/* ä¿®æ­£å®Ÿè¡Œ */

	if (requestQuery.url !== null && requestQuery.title !== null && requestQuery.category !== null && requestQuery.priority !== null && requestQuery.selector_wrap !== null) {
		await dao.update(requestQuery.url, requestQuery.title, requestQuery.category, requestQuery.priority, requestQuery.browser, requestQuery.selector_wrap, requestQuery.selector_date, requestQuery.selector_content);
		logger.info('ãƒ‡ãƒ¼ã‚¿æ›´æ–°', requestQuery.url);

		const httpResponse = new HttpResponseUtil(Astro.request);
		return httpResponse.response303(); // åˆæœŸç”»é¢ã«é·ç§»
	}
} else if (requestQuery.action_delete) {
	/* å‰Šé™¤ */
	if (requestQuery.url !== null) {
		await dao.delete(requestQuery.url);
		logger.info('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤', requestQuery.url);

		const httpResponse = new HttpResponseUtil(Astro.request);
		return httpResponse.response303(); // åˆæœŸç”»é¢ã«é·ç§»
	}
} else if (requestQuery.action_revise_preview) {
	/* ä¿®æ­£ãƒ‡ãƒ¼ã‚¿é¸æŠ */
	if (requestQuery.url !== null) {
		const reviseData = await dao.getReviseData(requestQuery.url);
		if (reviseData !== null) {
			requestQuery.title = reviseData.title;
			requestQuery.category = reviseData.category;
			requestQuery.priority = reviseData.priority;
			requestQuery.browser = reviseData.browser;
			requestQuery.selector_wrap = reviseData.selector_wrap;
			requestQuery.selector_date = reviseData.selector_date;
			requestQuery.selector_content = reviseData.selector_content;
		}
	}
}

/* åˆæœŸè¡¨ç¤º */
const categoryMaster = await dao.getCategoryMaster(); // ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±
const priorityMaster = await dao.getPriorityMaster(); // å„ªå…ˆåº¦æƒ…å ±
const newsPageListDto = await dao.getNewsPageList(); // å·¡å›ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿

const newsPageList: Map<
	string,
	{
		url: string;
		title: string;
		priority: string;
		browser: boolean;
		selector_wrap: string;
		selector_date: string | null;
		selector_content: string | null;
	}[]
> = new Map();
for (const newsPage of newsPageListDto) {
	const categoryName = newsPage.category;

	const newsPageOfCategoryView = newsPageList.get(categoryName) ?? [];
	newsPageOfCategoryView.push({
		url: newsPage.url,
		title: newsPage.title,
		priority: newsPage.priority,
		browser: newsPage.browser,
		selector_wrap: newsPage.selector_wrap,
		selector_date: newsPage.selector_date,
		selector_content: newsPage.selector_content,
	});

	newsPageList.set(categoryName, newsPageOfCategoryView);
}
---

<Layout structuredData={structuredData}>
	<Section slugger={slugger} heading="ãƒ‡ãƒ¼ã‚¿ç™»éŒ²">
		<form action={pagePath} method="post" class="c-stack">
			<div class="p-form-grid">
				<div class="p-form-grid__group">
					<fieldset>
						<legend class="p-form-grid__legend">
							<label for="fc-url" class="c-label">URL <strong class="c-label-icon -required">å¿…é ˆ</strong></label>
						</legend>
						<div class="p-form-grid__contents">
							<div class="c-form-controls">
								{(requestQuery.action_revise_preview || requestQuery.action_revise) && <input type="url" class="c-input -full js-convert-trim" id="fc-url" name="url" value={requestQuery.url} required="" readonly="" />}
								{!requestQuery.action_revise_preview && !requestQuery.action_revise && <input type="url" class="c-input -full js-convert-trim" id="fc-url" name="url" value={requestQuery.url} required="" />}
							</div>
						</div>
					</fieldset>
				</div>
				<div class="p-form-grid__group">
					<fieldset>
						<legend class="p-form-grid__legend">
							<label for="fc-title" class="c-label">ã‚¿ã‚¤ãƒˆãƒ« <strong class="c-label-icon -required">å¿…é ˆ</strong></label>
						</legend>
						<div class="p-form-grid__contents">
							<div class="c-form-controls">
								<input class="c-input -full js-convert-trim" id="fc-title" name="title" value={requestQuery.title} required="" />
							</div>
						</div>
					</fieldset>
				</div>
				<div class="p-form-grid__group">
					<fieldset>
						<legend class="p-form-grid__legend">
							<label for="fc-category" class="c-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼ <strong class="c-label-icon -required">å¿…é ˆ</strong></label>
						</legend>
						<div class="p-form-grid__contents">
							<div class="c-form-controls">
								<select class="c-select" id="fc-category" name="category">
									{
										categoryMaster.map((category) => (
											<>
												{requestQuery.category === category.fk && (
													<option value={category.fk} selected="">
														{category.name}
													</option>
												)}
												{requestQuery.category !== category.fk && <option value={category.fk}>{category.name}</option>}
											</>
										))
									}
								</select>
							</div>
						</div>
					</fieldset>
				</div>
				<div class="p-form-grid__group">
					<fieldset>
						<legend class="p-form-grid__legend">
							<label for="fc-priority" class="c-label">å„ªå…ˆåº¦ <strong class="c-label-icon -required">å¿…é ˆ</strong></label>
						</legend>
						<div class="p-form-grid__contents">
							<div class="c-form-controls">
								<select class="c-select" id="fc-priority" name="priority">
									{
										priorityMaster.map((priority) => (
											<>
												{requestQuery.priority === priority.fk && (
													<option value={priority.fk} selected="">
														{priority.name}
													</option>
												)}
												{requestQuery.priority !== priority.fk && <option value={priority.fk}>{priority.name}</option>}
											</>
										))
									}
								</select>
							</div>
						</div>
					</fieldset>
				</div>
				<div class="p-form-grid__group">
					<fieldset>
						<legend class="p-form-grid__legend">ãƒ–ãƒ©ã‚¦ã‚¶</legend>
						<div class="p-form-grid__contents">
							<div class="c-form-controls">
								<label class="c-label -check">
									{requestQuery.browser && <input type="checkbox" name="browser" value="1" checked="" />}
									{!requestQuery.browser && <input type="checkbox" name="browser" value="1" />}
									<span class="c-label__text">ã‚¦ã‚§ãƒ–ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹</span></label
								>
							</div>
						</div>
					</fieldset>
				</div>
				<div class="p-form-grid__group">
					<fieldset>
						<legend class="p-form-grid__legend">
							<label for="fc-selectorwrap" class="c-label">ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆåŒ…æ‹¬ï¼‰ <strong class="c-label-icon -required">å¿…é ˆ</strong></label>
						</legend>
						<div class="p-form-grid__contents">
							<div class="c-form-controls">
								<input class="c-input -full js-convert-trim" id="fc-selectorwrap" name="selectorwrap" value={requestQuery.selector_wrap} required="" />
							</div>
						</div>
					</fieldset>
				</div>
				<div class="p-form-grid__group">
					<fieldset>
						<legend class="p-form-grid__legend">
							<label for="fc-selectordate" class="c-label">ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆæ—¥ä»˜ï¼‰ <strong class="c-label-icon -optional">ä»»æ„</strong></label>
						</legend>
						<div class="p-form-grid__contents">
							<div class="c-form-controls">
								<input class="c-input -full js-convert-trim" id="fc-selectordate" name="selectordate" value={requestQuery.selector_date} />
							</div>
						</div>
					</fieldset>
				</div>
				<div class="p-form-grid__group">
					<fieldset>
						<legend class="p-form-grid__legend">
							<label for="fc-selectorcontent" class="c-label">ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆå†…å®¹ï¼‰ <strong class="c-label-icon -optional">ä»»æ„</strong></label>
						</legend>
						<div class="p-form-grid__contents">
							<div class="c-form-controls">
								<input class="c-input -full js-convert-trim" id="fc-selectorcontent" name="selectorcontent" value={requestQuery.selector_content} />
							</div>
						</div>
					</fieldset>
				</div>
			</div>

			<div class="c-form-controls -submit">
				{
					(requestQuery.action_revise_preview || requestQuery.action_revise) && (
						<p>
							<button class="c-submit" name="actionrev" value="1">
								ä¿®æ­£
							</button>
						</p>
					)
				}
				{
					!requestQuery.action_revise_preview && !requestQuery.action_revise && (
						<p>
							<button class="c-submit" name="actionadd" value="1">
								ç™»éŒ²
							</button>
						</p>
					)
				}
			</div>
		</form>
	</Section>

	{
		[...newsPageList].map(([categoryName, newsPageOfCategory]) => (
			<Section slugger={slugger} heading={categoryName}>
				<table class="p-table p-admin-crawler-table">
					<thead>
						<tr>
							<td />
							<th scope="col">å¯¾è±¡ãƒšãƒ¼ã‚¸</th>
							<th scope="col">å„ªå…ˆ</th>
							<th scope="col">ğŸŒ</th>
							<th scope="col">åŒ…æ‹¬ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼</th>
							<th scope="col">æ—¥ä»˜ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼</th>
							<th scope="col">å†…å®¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼</th>
						</tr>
					</thead>
					<tbody>
						{newsPageOfCategory.map((newsPage) => (
							<tr>
								<td class="u-cell -wrap-no">
									<form action={pagePath} method="post">
										<p>
											<input type="hidden" name="url" value={newsPage.url} />
										</p>
										<p>
											<button name="actionrevpre" value="1" formmethod="get" class="c-submit -compact">
												ä¿®æ­£
											</button>
											<button name="actiondel" value="1" is="w0s-confirm-button" data-message="å‰Šé™¤ã—ã¾ã™ã‹?" class="c-submit -compact">
												å‰Šé™¤
											</button>
										</p>
									</form>
								</td>
								<td>
									<a href={`${pagePath}/data?url=${newsPage.url}`}>{newsPage.title}</a>
									<p style="margin-block-start: 0.5em; font-size: 80%">
										<a href={newsPage.url} referrerpolicy="no-referrer">
											{newsPage.url}
										</a>
									</p>
								</td>
								<td>{newsPage.priority}</td>
								<td>{newsPage.browser && <>âœ”</>}</td>
								<td class="u-cell -wrap-anywhere">{newsPage.selector_wrap}</td>
								<td class="u-cell -wrap-anywhere">{newsPage.selector_date}</td>
								<td class="u-cell -wrap-anywhere">{newsPage.selector_content}</td>
							</tr>
						))}
					</tbody>
				</table>
			</Section>
		))
	}
</Layout>
