---
import { getHTMLId } from '@util/crypto';
import Anchor from './+phrasing/Anchor.astro';

interface Props {
	sectionDepth: 1 | 2 | 3 | 4 | 5;
	title: string;
	summary?: string;
	link: string;
}

const { sectionDepth, title, summary, link: linkHref } = Astro.props;

let linkText: string;
if (linkHref.startsWith('https://blog.w0s.jp/')) {
	linkText = '告知記事';
} else if (linkHref.startsWith('https://www.amazon.co.jp/')) {
	linkText = 'Amazon 商品ページ';
} else {
	linkText = '紹介ページ';
}

const detailsContent = await Astro.slots.render('details');

const headingId = getHTMLId(`${title}${detailsContent}`);
const linkId = getHTMLId(`${linkHref}${detailsContent}`);
---

<div class="item-container">
	<div class="item">
		<dic class="text">
			{
				sectionDepth === 1 && (
					<h2 class="title" id={headingId}>
						<cite>{title}</cite>
					</h2>
				)
			}
			{
				sectionDepth === 2 && (
					<h3 class="title" id={headingId}>
						<cite>{title}</cite>
					</h3>
				)
			}
			{
				sectionDepth === 3 && (
					<h4 class="title" id={headingId}>
						<cite>{title}</cite>
					</h4>
				)
			}
			{
				sectionDepth === 4 && (
					<h5 class="title" id={headingId}>
						<cite>{title}</cite>
					</h5>
				)
			}
			{
				sectionDepth === 5 && (
					<h6 class="title" id={headingId}>
						<cite>{title}</cite>
					</h6>
				)
			}
			{
				summary !== undefined && (
					<p class="summary">
						<b>{summary}</b>
					</p>
				)
			}
			{Astro.slots.has('details') && <div class="details" set:html={detailsContent} />}
			<p class="link">
				<Anchor href={linkHref} id={linkId} aria-labelledby={[linkId, headingId]}>{linkText}</Anchor>
			</p>
		</dic>
		<div class="image"><slot name="image" /></div>
	</div>
</div>

<style>
	@layer component {
		.item-container {
			--_stack-margin-base: 1rem;

			container: book-item / inline-size;
			line-height: var(--line-height-narrow);
		}

		.item {
			display: block grid;
			grid-template-areas: 'image text';
			grid-template-columns: auto 1fr;
			gap: 15px;

			@container book-item (inline-size <= calc(160px + 1px * 2 + 15px + 8em)) {
				grid-template-areas:
					'text'
					'image';
			}
		}

		.text {
			grid-area: text;

			& > * + .summary {
				margin-block-start: calc(var(--_stack-margin-base) / 4);
			}

			& > * + .details,
			& > * + .link {
				margin-block-start: var(--_stack-margin-base);
			}

			& > .details + .link {
				margin-block-start: calc(var(--_stack-margin-base) / 2);
			}
		}

		.image {
			grid-area: image;

			& :global(img) {
				display: block flow;
				border: 1px solid var(--color-black);
				block-size: auto;
				max-inline-size: 100%;
			}
		}

		.title {
			font-size: calc(100% * pow(var(--font-ratio), 1));
			font-weight: var(--font-weight-bold);
		}

		.summary {
			font-size: calc(100% / pow(var(--font-ratio), 1));

			& :global(b) {
				font-weight: var(--font-weight-normal);
			}
		}

		.link {
			--_bullet-inline-size: 0.45em;
			--_bullet-block-size: 0.75em;
			--_bullet-color: var(--link-color-bullet);
			--_bullet-gap: 0.5em;

			margin-inline-start: calc(var(--_bullet-inline-size) + var(--_bullet-gap));

			& :global(:any-link) {
				margin-inline-start: calc(0px - var(--_bullet-inline-size) - var(--_bullet-gap));
				outline-offset: var(--outline-offset-linkonly);
			}

			& :global(:any-link:hover) {
				--_bullet-color: var(--link-color-hover);
			}

			& :global(:any-link::before) {
				display: inline flow-root;
				clip-path: var(--shape-link-triangle);
				margin-inline-end: var(--_bullet-gap);
				border-block-start: var(--_bullet-block-size) solid var(--_bullet-color);
				inline-size: var(--_bullet-inline-size);
				content: '';
			}
		}
	}
</style>
